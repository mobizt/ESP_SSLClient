name: Arduino CLI Library Compile

on:
  push:
    paths-ignore:
      - '**.md'
      - '.github/workflows/compile_examples.yml'
  pull_request:
    paths-ignore:
      - '**.md'
      - '.github/workflows/compile_examples.yml'

jobs:
  compile:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        board_config:
          # --- Arduino SAMD/Renesas (Official Core) ---
          - { name: 'MKR WiFi 1010', board: 'arduino:samd:mkrwifi1010', platform: 'arduino:samd', category: 'standard' }
          - { name: 'UNO R4 WiFi', board: 'arduino:renesas_uno:unor4wifi', platform: 'arduino:renesas_uno', category: 'standard' }
          
          # --- ESP32 Family (Requires Custom URL) ---
          - { name: 'ESP32 Dev Module', board: 'esp32:esp32:esp32doit-devkit-v1', platform: 'esp32:esp32', url: 'https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json', category: 'standard' }
          - { name: 'LOLIN32', board: 'esp32:esp32:lolin32', platform: 'esp32:esp32', url: 'https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json', category: 'standard' }
          
          # --- ESP8266 (Requires Custom URL) ---
          - { name: 'D1 Mini', board: 'esp8266:esp8266:d1_mini', platform: 'esp8266:esp8266', url: 'https://arduino.esp8266.com/stable/package_esp8266com_index.json', category: 'standard' }

          # --- STM32 (Isolated/Direct Install - URL Updated) ---
          # Using the commonly successful GitHub BoardManagerFiles URL format.
          - { name: 'Nucleo F401RE', board: 'STM32:stm32:Nucleo_F401RE', platform: 'STM32:stm32', url: 'https://github.com/stm32duino/BoardManagerFiles/raw/master/package_stm_index.json', category: 'stm32' }

    name: Compile ${{ matrix.board_config.name }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      # 1. Install Arduino CLI
      - name: üõ†Ô∏è Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # 2. Add custom platform URLs for ESP and update index
      - name: üåê Configure & Update Index
        run: |
          # Add URLs for non-standard cores (ESP and STM32)
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli config add board_manager.additional_urls https://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli config add board_manager.additional_urls https://github.com/stm32duino/BoardManagerFiles/raw/master/package_stm_index.json # <-- STM32 URL ADDED TO GLOBAL CONFIG
          # Run update once
          arduino-cli core update-index
          
      # 3. FIX: Install STM32 Platform (Direct Index Access)
      - name: üì• Install STM32 Platform
        if: ${{ matrix.board_config.category == 'stm32' }}
        run: |
          # The URL was added to the config in step 2. Now we install the platform.
          # We use the --additional-urls flag here as a redundancy measure just in case.
          arduino-cli core install ${{ matrix.board_config.platform }} --additional-urls https://github.com/stm32duino/BoardManagerFiles/raw/master/package_stm_index.json

      # 4. Install All Other Platforms (ESP, Arduino)
      - name: üì• Install Other Platforms
        if: ${{ matrix.board_config.category != 'stm32' }}
        run: |
          # Platforms can be installed now that the global index has been updated
          arduino-cli core install ${{ matrix.board_config.platform }}
          
      # 5. Create the test sketch containing your provided code
      - name: üìù Create test sketch
        run: |
          mkdir -p test_sketch
          cat << EOF > test_sketch/test_sketch.ino
          #include <ESP_SSLClient.h>
          
          ESP_SSLClient ssl_client;
          
          void setup()
          {
              ssl_client.setInsecure();
              ssl_client.setBufferSizes(2048, 512);
              ssl_client.connect("mock.com", 443);
              ssl_client.stop();
          }
          
          void loop()
          {
          }
          EOF

      # 6. Compile the sketch against the FQBN
      - name: ‚öôÔ∏è Compile Sketch for ${{ matrix.board_config.name }}
        run: arduino-cli compile --fqbn ${{ matrix.board_config.board }} --library . test_sketch